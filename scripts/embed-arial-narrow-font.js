/**
 * Embeds an Arial Narrow–compatible TTF and writes src/fonts/arialNarrowBase64.ts for PDF export.
 *
 * Usage (path required):
 *   node scripts/embed-arial-narrow-font.js /path/to/font.ttf
 *
 * Example:
 *   node scripts/embed-arial-narrow-font.js ~/Downloads/LiberationSansNarrow-Regular.ttf
 *
 * You can also pass a .tar.gz from the Liberation Sans Narrow release; the script will extract the TTF.
 */

const https = require('https');
const fs = require('fs');
const zlib = require('zlib');
const path = require('path');

const FONT_TS_PATH = path.join(__dirname, '..', 'src', 'fonts', 'arialNarrowBase64.ts');
const RELEASE_URL = 'https://github.com/liberationfonts/liberation-sans-narrow/releases/download/1.07.6/liberation-narrow-fonts-ttf-1.07.6.tar.gz';

function fetch(url) {
  return new Promise((resolve, reject) => {
    const req = https.get(url, { headers: { 'User-Agent': 'Node' } }, (res) => {
      if (res.statusCode === 302 || res.statusCode === 301) {
        return fetch(res.headers.location).then(resolve, reject);
      }
      const chunks = [];
      res.on('data', (ch) => chunks.push(ch));
      res.on('end', () => resolve(Buffer.concat(chunks)));
      res.on('error', reject);
    });
    req.on('error', reject);
  });
}

function extractTtfFromTarGz(buffer) {
  const inflated = zlib.gunzipSync(buffer);
  const entries = [];
  let offset = 0;
  while (offset + 512 <= inflated.length) {
    const name = inflated.slice(offset, offset + 100).toString('utf8').replace(/\0.*$/, '').trim();
    const sizeStr = inflated.slice(offset + 124, offset + 136).toString('utf8').trim();
    const size = parseInt(sizeStr, 8) || 0;
    offset += 512;
    if (name.endsWith('.ttf')) {
      const ttf = inflated.slice(offset, offset + size);
      if (ttf.length > 1000) entries.push({ name, size, offset, ttf });
    }
    offset += Math.ceil((size || 0) / 512) * 512;
  }
  // Prefer Regular (not Italic/Bold) for body text
  const regular = entries.find((e) => /Regular|normal/i.test(e.name) && !/Italic|Bold/i.test(e.name));
  if (regular) return regular.ttf;
  return entries.length > 0 ? entries[0].ttf : null;
}

async function run() {
  const customPath = process.argv[2];
  let base64;

  if (customPath) {
    if (!fs.existsSync(customPath)) {
      throw new Error(`File not found: ${customPath}\nUse the full path to your TTF file, e.g.:\n  node scripts/embed-arial-narrow-font.js ~/Downloads/ArialNarrow.ttf`);
    }
    console.log('Using local file:', customPath);
    const buf = fs.readFileSync(customPath);
    if (customPath.toLowerCase().endsWith('.tar.gz')) {
      const ttf = extractTtfFromTarGz(buf);
      if (!ttf) throw new Error('No TTF found in archive');
      base64 = ttf.toString('base64');
    } else {
      base64 = buf.toString('base64');
    }
  } else {
    console.log('Arial Narrow is not applied in PDFs because the font is not embedded (src/fonts/arialNarrowBase64.ts is empty).');
    console.log('');
    console.log('To embed the font, provide a path to a TTF file:');
    console.log('  1. Download Liberation Sans Narrow from https://github.com/liberationfonts/liberation-sans-narrow/releases');
    console.log('     (e.g. liberation-narrow-fonts-ttf-1.07.6.tar.gz — extract it to get the .ttf)');
    console.log('  2. Run: node scripts/embed-arial-narrow-font.js /path/to/LiberationSansNarrow-Regular.ttf');
    console.log('');
    console.log('Or use any Arial Narrow–compatible .ttf from your system.');
    throw new Error('No font path provided. Run with a path to a .ttf file.');
  }

  const dir = path.dirname(FONT_TS_PATH);
  if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });

  const content = `// Generated by scripts/embed-arial-narrow-font.js – Arial Narrow–style font for PDF body text
// Source: Liberation Sans Narrow (https://github.com/liberationfonts/liberation-sans-narrow)

export const arialNarrowBase64 =
${JSON.stringify(base64)};
`;

  fs.writeFileSync(FONT_TS_PATH, content, 'utf8');
  console.log('Wrote', FONT_TS_PATH);
}

run().catch((err) => {
  console.error('Error:', err.message);
  console.log('To use your own TTF run: node scripts/embed-arial-narrow-font.js /path/to/font.ttf');
  process.exit(1);
});
